From 6fcc6a8d59fe4c6d6a9f4582dd8c4fe17c8afca4 Mon Sep 17 00:00:00 2001
From: Tim Lunn <tim@feathertop.org>
Date: Sat, 18 Jan 2014 15:12:09 +1100
Subject: [PATCH 2/2] Revert "Update for Cogl API breaks"

This reverts commit d2a1db8834bf0a9007bf6924b006a6f2c94ce88d.
---
 configure.ac                            | 2 +-
 src/compositor/meta-texture-rectangle.c | 9 +++++++--
 src/compositor/meta-texture-rectangle.h | 4 +++-
 src/compositor/meta-texture-tower.c     | 4 ++++
 src/compositor/meta-window-actor.c      | 5 ++++-
 src/core/meta-cursor-tracker.c          | 1 +
 6 files changed, 20 insertions(+), 5 deletions(-)

diff --git a/configure.ac b/configure.ac
index 621f76b..95912ba 100644
--- a/configure.ac
+++ b/configure.ac
@@ -76,7 +76,7 @@ MUTTER_PC_MODULES="
    gsettings-desktop-schemas >= 3.7.3
    xcomposite >= 0.2 xfixes xrender xdamage xi >= 1.6.0
    $CLUTTER_PACKAGE >= 1.15.90
-   cogl-1.0 >= 1.17.1
+   cogl-1.0 >= 1.15.6
    upower-glib >= 0.99.0
    gnome-desktop-3.0
 "
diff --git a/src/compositor/meta-texture-rectangle.c b/src/compositor/meta-texture-rectangle.c
index 450155d..3fc9430 100644
--- a/src/compositor/meta-texture-rectangle.c
+++ b/src/compositor/meta-texture-rectangle.c
@@ -30,8 +30,10 @@ CoglTexture *
 meta_texture_rectangle_new (unsigned int width,
                             unsigned int height,
                             CoglPixelFormat format,
+                            CoglPixelFormat internal_format,
                             unsigned int rowstride,
-                            const guint8 *data)
+                            const guint8 *data,
+                            GError **error)
 {
   ClutterBackend *backend =
     clutter_get_default_backend ();
@@ -39,7 +41,10 @@ meta_texture_rectangle_new (unsigned int width,
     clutter_backend_get_cogl_context (backend);
   CoglTextureRectangle *tex_rect;
 
-  tex_rect = cogl_texture_rectangle_new_with_size (context, width, height);
+  tex_rect = cogl_texture_rectangle_new_with_size (context,
+                                                   width, height,
+                                                   internal_format,
+                                                   error);
   if (tex_rect == NULL)
     return NULL;
 
diff --git a/src/compositor/meta-texture-rectangle.h b/src/compositor/meta-texture-rectangle.h
index 7b84229..30f60d3 100644
--- a/src/compositor/meta-texture-rectangle.h
+++ b/src/compositor/meta-texture-rectangle.h
@@ -32,8 +32,10 @@ CoglTexture *
 meta_texture_rectangle_new (unsigned int width,
                             unsigned int height,
                             CoglPixelFormat format,
+                            CoglPixelFormat internal_format,
                             unsigned int rowstride,
-                            const guint8 *data);
+                            const guint8 *data,
+                            GError **error);
 
 gboolean
 meta_texture_rectangle_check (CoglTexture *texture);
diff --git a/src/compositor/meta-texture-tower.c b/src/compositor/meta-texture-tower.c
index 019aaf4..9a30de0 100644
--- a/src/compositor/meta-texture-tower.c
+++ b/src/compositor/meta-texture-tower.c
@@ -363,9 +363,13 @@ texture_tower_create_texture (MetaTextureTower *tower,
         meta_texture_rectangle_new (width, height,
                                     /* data format */
                                     TEXTURE_FORMAT,
+                                    /* internal cogl format */
+                                    TEXTURE_FORMAT,
                                     /* rowstride */
                                     width * 4,
                                     /* data */
+                                    NULL,
+                                    /* error */
                                     NULL);
     }
   else
diff --git a/src/compositor/meta-window-actor.c b/src/compositor/meta-window-actor.c
index af7899a..d0240ba 100644
--- a/src/compositor/meta-window-actor.c
+++ b/src/compositor/meta-window-actor.c
@@ -2103,7 +2103,10 @@ build_and_scan_frame_mask (MetaWindowActor       *self,
     {
       mask_texture = meta_texture_rectangle_new (tex_width, tex_height,
                                                  COGL_PIXEL_FORMAT_A_8,
-                                                 stride, mask_data);
+                                                 COGL_PIXEL_FORMAT_A_8,
+                                                 stride,
+                                                 mask_data,
+                                                 NULL /* error */);
     }
   else
     {
diff --git a/src/core/meta-cursor-tracker.c b/src/core/meta-cursor-tracker.c
index 84f3185..d1b365e 100644
--- a/src/core/meta-cursor-tracker.c
+++ b/src/core/meta-cursor-tracker.c
@@ -307,6 +307,7 @@ ensure_xfixes_cursor (MetaCursorTracker *tracker)
                                           cursor_image->width,
                                           cursor_image->height,
                                           CLUTTER_CAIRO_FORMAT_ARGB32,
+                                          COGL_PIXEL_FORMAT_ANY,
                                           cursor_image->width * 4, /* stride */
                                           cursor_data,
                                           NULL);
-- 
1.8.5.3


